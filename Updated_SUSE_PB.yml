---
- name: Detect and Execute SUSE OS-specific tasks
  hosts: all
  gather_facts: yes
  vars:
    domain_name: "wikilab.asia"
    username: "sainath@wikilab.asia"
    password: "Redhat123"


  tasks:
  
    - name: Check if running on SUSE
      fail:
        msg: "This playbook only runs on SUSE 12 & 15 servers."
      when: ansible_distribution_major_version | int == 11
      tags: always
      
    - name: Gather OS version and distribution facts
      debug:
        var: ansible_distribution_version
      register: os_version

    - name: Extract OS major version from facts
      set_fact:
        ansible_distribution_major_version: "{{ ansible_distribution_version.split('.')[0] }}"

    - name: Print the OS major version
      debug:
        var: ansible_distribution_major_version

 #Prechecks to Join Domain       
    - name: Check if user sainath
      shell: getent passwd sainath
      register: check_user
      changed_when: False
      ignore_errors: True
      
    - name: Check if LDAP port is in use
      shell: lsof -i:636
      register: check_ldap
      changed_when: False
      ignore_errors: True

    - name: Print success message if SUSE server joined domain
      debug:
        msg: "SUSE server joined domain"
      when: check_user.rc == 0 and check_ldap.rc == 0

    - name: Print failure message if SUSE server Not joined domain
      debug:
        msg: "SUSE server Not joined domain"
      when: check_user.rc != 0 or check_ldap.rc != 0

    - name: Exit the playbook if SUSE server joined domain
      fail:
        msg: "This Server Already Joined Domain."
      when: check_user.rc == 0 and check_ldap.rc == 0
      tags: always

#Install necessary packages
    - name: Install packages on SLES 15
      command: zypper --non-interactive install adcli sssd sssd-ldap sssd-ad sssd-tools realmd
      when: ansible_distribution_major_version|int == 15

    - name: Install packages on SLES 12
      command: zypper --non-interactive install adcli sssd sssd-ldap sssd-ad sssd-tools
      when: ansible_distribution_major_version|int == 12
      
    - name: Copy realm RPM file to temporary directory
      copy:
        src: testfolder/realmd-0.16.3-lp151.2.4.x86_64.rpm
        dest: /tmp/realmd-0.16.3-lp151.2.4.x86_64.rpm
      when: ansible_distribution_major_version|int == 12

    - name: Install realm RPM using rpm command
      command: rpm -ivh /tmp/realmd-0.16.3-lp151.2.4.x86_64.rpm
      ignore_errors: yes
      when: ansible_distribution_major_version|int == 12

#    - name: Update the Krb5 configuration
#      copy:
#        src: testfolder/krb5.conf
#        dest: /etc/krb5.conf
#        mode: "0644"

    - name: Join domain (SUSE 12 and 15)
      shell: echo -n "{{password}}" | adcli join {{domain_name}} -U sainath -v --stdin-password
      register: join_domain
      changed_when: False
      #no_log: True

    - name: Modify SSSD Configuration
      copy:
        src: testfolder/sssd.conf
        dest: /etc/sssd/sssd.conf
        mode: "0600"
        
    - name: Check realm list
      shell: realm list | egrep "realm-name|domain-name"
      register: check_realm
      changed_when: False
      ignore_errors: True 
      
    - name: Print success message if domain join was successful
      debug:
        msg: "Successfully joined the domain {{ domain_name }}"
      when: check_realm.rc == 0


