- name: Configure Samba and Winbind on Solaris
  hosts: all
  become: yes
  tasks:
    - name: Check if the server is joined to the domain
      command: wbinfo -t
      register: domain_join_status
      ignore_errors: yes

    - name: Determine if the server is already joined to the domain
      set_fact:
        already_joined: "{{ domain_join_status.rc == 0 }}"

    - name: Print message if server is already joined
      debug:
        msg: "Server is already joined to the domain."
      when: already_joined

    - name: Stop playbook execution if server is already joined
      meta: end_play
      when: already_joined

    - name: Copy krb5.conf to the server if it doesn't exist
      copy:
        src: krb5.conf_solaris
        dest: /etc/krb5.conf

    - name: Copy smb.conf to the server if it doesn't exist
      copy:
        src: smb.conf_solaris
        dest: /etc/samba/smb.conf
        
    - name: Set default property
      command: svccfg -s svc:/system/name-service/switch setprop config/default=astring:files

    - name: Set password property
      command: svccfg -s svc:/system/name-service/switch setprop config/password=astring:"files winbind [ TRYAGAIN = 3 ]"

    - name: Set group property
      command: svccfg -s svc:/system/name-service/switch setprop config/group=astring:"files winbind [TRYAGAIN=3]"

    - name: Set host property
      command: svccfg -s svc:/system/name-service/switch setprop config/host=astring:"files dns mdns winbind"

    - name: Set printer property
      command: svccfg -s svc:/system/name-service/switch setprop config/printer=astring:"user files"

    - name: Refresh SMF service for name-service/switch
      command: svcadm refresh svc:/system/name-service/switch
